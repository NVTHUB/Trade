
-- 1. GIAI ƒêO·∫†N CHU·∫®N B·ªä (UI & MODULES)
-- ==========================================
repeat task.wait(1) until game:IsLoaded()
    and game:GetService("ReplicatedStorage"):FindFirstChild("ClientModules")
    and game:GetService("ReplicatedStorage").ClientModules:FindFirstChild("Core")

local RS = game:GetService("ReplicatedStorage")
local API = RS:WaitForChild("API")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local ClientData = require(RS.ClientModules.Core.ClientData)
local Router = require(RS.ClientModules.Core.RouterClient.RouterClient)

-- Ch·ªëng treo m√°y (Anti AFK)
task.spawn(function()
    local vu = game:GetService("VirtualUser")
    LocalPlayer.Idled:Connect(function()
        vu:CaptureController()
        vu:ClickButton2(Vector2.new())
    end)
end)

-- T·∫Øt h·ªôi tho·∫°i phi·ªÅn ph·ª©c
if PlayerGui:FindFirstChild("DialogApp") then PlayerGui.DialogApp.Enabled = false end

-- GIAI ƒêO·∫†N: GI·∫¢I M√É REMOTE (DEHASH)
local function dehash()
    pcall(function()
        local mapping = debug.getupvalue(Router.init, 7)
        for name, remote in pairs(mapping) do
            if typeof(remote) == "Instance" then remote.Name = name end
        end
    end)
end
dehash()
print("[Dehash] ƒê√£ ho√†n th√†nh")

-- GIAI ƒêO·∫†N: V√ÄO GAME & CH·ªåN ƒê·ªòI
local function enter_the_game()
    local args = {[1] = "Parents", [2] = {["source_for_logging"] = "intro_sequence"}}
    API:WaitForChild("TeamAPI/ChooseTeam"):InvokeServer(unpack(args))
    task.wait(1)

    local ui_stuff = require(RS.Fsys).load("UIManager")
    ui_stuff.set_app_visibility("MainMenuApp", false)
    ui_stuff.set_app_visibility("NewsApp", false)
    ui_stuff.set_app_visibility("DialogApp", false)

    task.wait(2)
    API:WaitForChild("DailyLoginAPI/ClaimDailyReward"):InvokeServer()
end
enter_the_game()

-- ƒê·ª£i nh√¢n v·∫≠t xu·∫•t hi·ªán ho√†n to√†n
repeat task.wait() until LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
print("‚úÖ ƒê√£ v√†o game th√†nh c√¥ng")

-- ==========================================
-- 3. GIAI ƒêO·∫†N: KI·ªÇM TRA / L·∫§Y B·∫∞NG GIAO D·ªäCH
-- ==========================================
local function checkTradeLicense()
    if ClientData.get("has_trade_license") ~= true then
        print("üìú ƒêang t·ª± ƒë·ªông l·∫•y B·∫±ng giao d·ªãch...")
        pcall(function()
            API:WaitForChild("SettingsAPI/SetBooleanFlag"):FireServer("has_talked_to_trade_quest_npc", true)
            task.wait(0.5)
            API:WaitForChild("TradeAPI/BeginQuiz"):FireServer()
            task.wait(1)
            local quiz = ClientData.get("trade_license_quiz_manager")["quiz"]
            for _, qdata in pairs(quiz) do
                API:WaitForChild("TradeAPI/AnswerQuizQuestion"):FireServer(qdata["answer"])
                task.wait(0.7)
            end
        end)
        print("‚úÖ ƒê√£ m·ªü kh√≥a B·∫±ng giao d·ªãch!")
        task.wait(1)
    else
        print("‚úÖ ƒê√£ c√≥ B·∫±ng giao d·ªãch.")
    end
end
checkTradeLicense()

-- ==========================================
-- 4. H·ªÜ TH·ªêNG AUTO TRADE (CH√çNH)
-- ==========================================

-- FUNCTION A: D√ÄNH CHO ACC NH·∫¨N
local function FunctionA()
    print("üíé CH·∫æ ƒê·ªò: ACC NH·∫¨N ƒêANG CH·∫†Y")
    API:WaitForChild("TradeAPI/TradeRequestReceived").OnClientEvent:Connect(function(sender)
        if not sender then return end
        pcall(function() 
            API["PlayerProfileAPI/RefreshProfile"]:InvokeServer(sender) 
            task.wait(0.2)
            API["TradeAPI/AcceptOrDeclineTradeRequest"]:InvokeServer(sender, true) 
        end)
    end)

    task.spawn(function()
        while task.wait(0.1) do
            pcall(function() API["TradeAPI/AcceptNegotiation"]:FireServer() end)
            pcall(function() API["TradeAPI/ConfirmTrade"]:FireServer() end)
        end
    end)
end

-- FUNCTION B: D√ÄNH CHO ACC G·ª¨I
local function FunctionB()
    print("üöÄ CH·∫æ ƒê·ªò: ACC G·ª¨I ƒêANG CH·∫†Y")
    local tradeRemotes = { send = nil, add = nil, accept = nil, confirm = nil }

    local function RefreshTradeRemotes()
        local success, upvalues = pcall(function() return debug.getupvalue(Router.init, 7) end)
        if success then
            tradeRemotes.send = upvalues["TradeAPI/SendTradeRequest"]
            tradeRemotes.add = upvalues["TradeAPI/AddItemToOffer"]
            tradeRemotes.accept = upvalues["TradeAPI/AcceptNegotiation"]
            tradeRemotes.confirm = upvalues["TradeAPI/ConfirmTrade"]
        end
    end

    -- Lu·ªìng 1: T·ª± ƒë·ªông g·ª≠i y√™u c·∫ßu Trade
    task.spawn(function()
        while true do
            RefreshTradeRemotes()
            local data = ClientData.get_data()[LocalPlayer.Name]
            local hasItems = false
            if data and data.inventory then
                for _, cat in pairs({"pets", "gifts"}) do
                    for _, info in pairs(data.inventory[cat] or {}) do
                        if table.find(getgenv().Config.item_to_trade, info.kind) then
                            hasItems = true; break
                        end
                    end
                end
            end

            if hasItems and tradeRemotes.send then
                local targets = getgenv().Config.username
                local targetName = (type(targets) == "table") and targets[math.random(1, #targets)] or targets
                local target = Players:FindFirstChild(targetName)
                if target and target ~= LocalPlayer then
                    pcall(function() tradeRemotes.send:FireServer(target) end)
                    task.wait(5) 
                end
            end
            task.wait(2)
        end
    end)

    -- Lu·ªìng 2: T·ª± ƒë·ªông b·ªè ƒë·ªì (0.1s) v√† x√°c nh·∫≠n (0.5s)
    task.spawn(function()
        while true do
            local data = ClientData.get_data()[LocalPlayer.Name]
            if data and data.inventory and tradeRemotes.add then
                for _, cat in pairs({"pets", "gifts"}) do
                    for id, info in pairs(data.inventory[cat] or {}) do
                        if table.find(getgenv().Config.item_to_trade, info.kind) then
                            pcall(function() tradeRemotes.add:FireServer(id) end)
                        end
                    end
                end
                pcall(function() 
                    tradeRemotes.accept:FireServer()
                    tradeRemotes.confirm:FireServer()
                end)
            end
            task.wait(2)
        end
    end)
end

-- ==========================================
-- 5. K√çCH HO·∫†T D·ª∞A TR√äN T√äN NH√ÇN V·∫¨T
-- ==========================================
local isTarget = false
local targets = getgenv().Config["username"]

if type(targets) == "table" then
    if table.find(targets, LocalPlayer.Name) then isTarget = true end
elseif targets == LocalPlayer.Name then
    isTarget = true
end

print("üåü Kh·ªüi ƒë·ªông ho√†n t·∫•t ‚Äî H·ªá th·ªëng Auto Trade ƒëang ch·∫°y üåü")
if isTarget then
    FunctionA()
else
    FunctionB()
end
