local RS = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local API = RS:WaitForChild("API")
local Router = require(RS.ClientModules.Core.RouterClient.RouterClient)
local ClientData = require(RS.ClientModules.Core.ClientData)

-- H√†m Dehash chung
local function dehash()
    pcall(function()
        local mapping = debug.getupvalue(Router.init, 7)
        for name, remote in pairs(mapping) do
            if typeof(remote) == "Instance" then 
                remote.Name = name 
            end
        end
    end)
end

dehash()

-- ANTI AFK
task.spawn(function()
    local vu = game:GetService("VirtualUser")
    while task.wait(120) do
        vu:CaptureController()
        vu:ClickButton2(Vector2.new())
        pcall(function() 
            LocalPlayer.Character.Humanoid.Jump = true 
        end)
    end
end)


-- FUNCTION A: D√ÄNH CHO ACC NH·∫¨N (M·ª•c ti√™u)
local function FunctionA()
    print("üíé CH·∫æ ƒê·ªò: ACC NH·∫¨N ƒêANG CH·∫†Y")

    -- T·ª± ƒë·ªông ch·∫•p nh·∫≠n y√™u c·∫ßu trade
    API:WaitForChild("TradeAPI/TradeRequestReceived").OnClientEvent:Connect(function(sender)
        if not sender then return end
        pcall(function() 
            API["PlayerProfileAPI/RefreshProfile"]:InvokeServer(sender) 
            task.wait(0.2)
            API["TradeAPI/AcceptOrDeclineTradeRequest"]:InvokeServer(sender, true) 
        end)
    end)

    -- Spam ƒê·ªìng √Ω & X√°c nh·∫≠n
    task.spawn(function()
        local acc = API:WaitForChild("TradeAPI/AcceptNegotiation")
        local conf = API:WaitForChild("TradeAPI/ConfirmTrade")
        while true do
            pcall(function() acc:FireServer() end)
            pcall(function() conf:FireServer() end)
            task.wait(0.1)
        end
    end)
end

-- FUNCTION B: D√ÄNH CHO ACC G·ª¨I 
local function FunctionB()
    print("üöÄ CH·∫æ ƒê·ªò: ACC G·ª¨I ƒêANG CH·∫†Y")
    
    local tradeRemotes = { send = nil, add = nil, accept = nil, confirm = nil }

    local function RefreshRemotes()
        local success, upvalues = pcall(function() return debug.getupvalue(Router.init, 7) end)
        if success and type(upvalues) == "table" then
            tradeRemotes.send = upvalues["TradeAPI/SendTradeRequest"]
            tradeRemotes.add = upvalues["TradeAPI/AddItemToOffer"]
            tradeRemotes.accept = upvalues["TradeAPI/AcceptNegotiation"]
            tradeRemotes.confirm = upvalues["TradeAPI/ConfirmTrade"]
        end
    end

    -- Lu·ªìng 1: T·ª± ƒë·ªông g·ª≠i y√™u c·∫ßu Trade
    task.spawn(function()
        while true do
            RefreshRemotes()
            local data = ClientData.get_data()[LocalPlayer.Name]
            local hasItems = false

            if data and data.inventory then
                for _, cat in pairs({"pets", "gifts"}) do
                    for _, info in pairs(data.inventory[cat] or {}) do
                        if table.find(getgenv().Config.item_to_trade, info.kind) then
                            hasItems = true; break
                        end
                    end
                end
            end

            if hasItems and tradeRemotes.send then
                local targets = getgenv().Config.username
                -- X·ª≠ l√Ω d√π Config l√† String hay Table
                local targetName = (type(targets) == "table") and targets[math.random(1, #targets)] or targets
                local target = Players:FindFirstChild(targetName)
                
                if target and target ~= LocalPlayer then
                    pcall(function() tradeRemotes.send:FireServer(target) end)
                    task.wait(5) 
                end
            end
            task.wait(2)
        end
    end)

    -- Lu·ªìng 2: T·ª± ƒë·ªông b·ªè ƒë·ªì v√† x√°c nh·∫≠n
    task.spawn(function()
        while true do
            local data = ClientData.get_data()[LocalPlayer.Name]
            if data and data.inventory and tradeRemotes.add then
                for _, cat in pairs({"pets", "gifts"}) do
                    for id, info in pairs(data.inventory[cat] or {}) do
                        if table.find(getgenv().Config.item_to_trade, info.kind) then
                            pcall(function() tradeRemotes.add:FireServer(id) end)
                        end
                    end
                end
                pcall(function() 
                    tradeRemotes.accept:FireServer()
                    tradeRemotes.confirm:FireServer()
                end)
            end
            task.wait(0.5)
        end
    end)
end

-- ==========================================
-- 3. KH·ªûI CH·∫†Y (LOGIC CHECK)
-- ==========================================
local isTarget = false
local targets = getgenv().Config["username"]

if type(targets) == "table" then
    if table.find(targets, LocalPlayer.Name) then isTarget = true end
elseif targets == LocalPlayer.Name then
    isTarget = true
end

if isTarget then
    FunctionA()
else
    FunctionB()
end
